<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 10초만에 세계여행 가는 상상 </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/index.css" rel="stylesheet">
</head>
<body>
    <form id = "indexForm">
        <article class="comic">
            <div class="panel">
                <input type = "text" class = "city" name = "city" placeholder="가고 싶은 도시명은?">
                <br>
                <input type = "number" class = "numberOfDays" name = "numberOfDays" placeholder="몇 일 여행이 될까요?"
                max ="5">
                <br>
                <button id = "goTravle" type = "submit"> 자 이제 떠나볼까? </button>    
            </div>            
        </article>
        
        <!-- 위 폼의 경우, Enter로 버튼을 누르는 기능을 추가하기 위해 submit 유형을 추가함 -->
        <!-- city / numberOfDays 를 fetch 로 GPT의 데이터를 받아오고 -->
        <!-- Loading 화면 중, GPT의 처리와 Parsing 등을 전부 진행함으로서 처리 대기 시간을 확보 -->
        
    </form>

    <div class = "loadingScreen">
        <!-- 로딩 스크린용 암막 구성 -->
    </div>

    <div class = "loadingAlert">
        <img src = './image/airplane.png' class = 'airplane'>
        <div> Loading <span id = "loadText"></span></div>

    </div>    

    <script>
        const $goTravle = document.querySelector('#goTravle')
        var $tempCity = ''
        var $city = document.querySelector('.city');
        var $numberOfDays = document.querySelector('.numberOfDays');
        var $cityData = [];
        const $loadingScreen = document.querySelector('.loadingScreen');
        const $loadingAlert = document.querySelector('.loadingAlert');
        const url = `https://estsoft-openai-api.jejucodingcamp.workers.dev/`;
        const data = []; 

        // 이벤트 리스너 발동 시 json 작성 및 fetch 수행
        $goTravle.addEventListener('click', e => {
            e.preventDefault()
            // 입력 값을 활용하여 질문 생성 
            const contents = $city.value;
            const numberOfDays = $numberOfDays.value;
            data.push({
                "role":"system",
                "content": "입력된 관광지의 추천장소" + numberOfDays + "군데 { cityPlace : 이름(영문) } 형식으로 출력. 설명은 뺄 것. "
            })
            data.push({            
                "role": "user",
                "content": contents                
            })
            $tempCity = $city.value;
            // $city.value = ''
            // $numberOfDays.value = ''
            $cityDataName = 'cityData' + $city.value; // cityData도쿄
            chatGPTAPI();
            // for문으로 반복하여 JSON의 배열을 변수에 입력 
            // 변수 사용시 localStorage에 담은 후 사용하도록 변경  
            
            setInterval(moveNextpage,2000);          
            loadingScreen();
        })       
        
        var $cityDataName = '';
        var $responseChoice = '';
        var $numberOfDaysLog = '';
        var $cityLog = '';
        var $cityDataOriginal = '';        
        var $cityPlaceNameLS = '';
        function chatGPTAPI() {
            // 페치를 시작하면 바로 로딩스크린 출력
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
                redirect: 'follow'
            })
            .then(res => res.json())
            .then(res => {
                // 로컬 스토리지에 저장 ( city, numberOfDays )
                $responseChoice = `${res.choices[0].message.content}`;
                
                $numberOfDaysLog = 'numberOfDays' + $city.value;
                $cityLog = 'city' + $city.value;
                localStorage.setItem($cityDataName,$responseChoice); // Log 저장용
                localStorage.setItem($cityLog, $city.value); // Log저장용
                localStorage.setItem($numberOfDaysLog, $numberOfDays.value); // Log 저장용
                // 저장된 값을 파싱 
                // 문자열을 개별 JSON 문자열로 분리하여 배열로 변환
                
                $cityDataOriginal = localStorage.getItem($cityDataName);                
                 // 이걸로 넘어가서 지도를 만들고 메뉴를 만들고 하면됨 
                // $cityData = $cityDataOriginal.split('\n').map(item => JSON.parse(item)); // JsonStyle로 변경               
                $cityData = JSON.parse($cityDataOriginal);                
                for (let i = 0; i < 5; i++) {
                    const city = $city.value;
                    var tempPlaceName = 'cityPlace' + city + i;  
                    var count = i+1;             
                    localStorage.setItem(tempPlaceName, $cityData['cityPlace'+count]) // ex 변수명 cityPlace도쿄1, 시부야
                }
                })   
        }              
        
        // 로딩화면 함수
        function loadingScreen(){
            if ( $loadingScreen.style.display != 'none' ) {
                $loadingScreen.style.display = 'block';
                $loadingAlert.style.display = 'block';
            }
            setInterval(plusDots, 500);
        }
        let dotsCount = 0;
        
        // loading의 ... 을 추가하는 함수
        function plusDots(){
            const dots = document.querySelector('#loadText');
            
            if (dotsCount < 5){
                dots.textContent += '.';
                dotsCount++;
            } else {
                dots.textContent = '';
                dotsCount = 0;
            }
        }

        // 다음 페이지로 넘어가는 함수
        function moveNextpage(){
            if( localStorage.getItem($cityData) != ''){
                window.location.href = "main.html";
            }
        }


    </script>

</body>
</html>